# Project Context
This is a Kubernetes Homelab repository managed via GitOps (Argo CD).
The infrastructure is built on Talos Linux and uses Cilium for networking.

# Tech Stack
- **Orchestration**: Kubernetes (Talos)
- **GitOps**: Argo CD (App of Apps pattern)
- **Manifest Management**: Kustomize + Helm Charts (Hybrid)
- **Automation**: Taskfile (go-task)
- **Networking**: Cilium

# Project Structure
- `apps/<category>/<app_name>`: Application manifests.
  - Each app should have a `kustomize.yaml`, `namespace.yaml`, and `values.yaml`.
  - Use `helmCharts` in `kustomization.yaml` to inflate charts.
- `apps/.argocd/`: Contains the "App of Apps" bootstrap configuration.
  - `apps/.argocd/apps.yaml`: ApplicationSet that manages all applications using a list generator.
  - `apps/.argocd/root-application.yaml`: The bootstrap manifest to initialize the App of Apps.
- `Taskfile.yml`: The source of truth for build and verification commands.
  - containers are used for all commands to ensure consistency across environments.

# Development Conventions

## 1. Adding a New Application
- Create a directory: `apps/<category>/<app_name>`.
- Create `namespace.yaml`:
  ```yaml
  apiVersion: v1
  kind: Namespace
  metadata:
    name: <app_name>
  ```
- Create `values.yaml`:
  - For initial development, ALWAYS disable persistence by default unless explicitly required.
  - Match the upstream chart's schema (check `persistence` nesting).
- Create `kustomization.yaml`:
  - Set `namespace: <app_name>`.
  - Include `resources: [namespace.yaml]`.
  - Define `helmCharts` block pointing to the upstream repo.
- Add an entry to the `elements` list in `apps/.argocd/apps.yaml` with the app's name, path, and namespace.

## 2. Verification
- ALWAYS run `task build` to verify Kustomize builds and Helm template inflation.
- Fix any linting errors or missing Helm repos immediately.

## 3. App of Apps Pattern
- The root application is defined in `apps/.argocd/root-application.yaml`.
- It syncs the `apps/.argocd` directory, which contains an `ApplicationSet` manifest.
- The `ApplicationSet` uses a list generator to create `Application` resources for each app defined in the `elements` list.

# Style Guidelines
- Prefer `kustomize` for overlaying changes on top of Helm charts.
- Keep `values.yaml` minimalâ€”only override what is necessary.
- Use explicit namespaces in Kustomization files.
